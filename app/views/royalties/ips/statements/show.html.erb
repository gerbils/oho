<%
    ok_mime_types = [
      "application/vnd.ms-excel.sheet.macroEnabled",
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    ].join(",")
  %>
<%
    def charge_basis(item)
      if item.basis == "unit"
        "x#{item.basis_for_charge.abs.to_i}"
      else
        number_to_currency(item.basis_for_charge)
      end
    end

def charge_factor(item)
  if item.basis == "unit"
    number_to_currency(item.factor_or_rate)
  elsif item.factor_or_rate == 100
    "100%"
    elseif item.factor_or_rate == -100
    "100%"
  else
    number_to_percentage(item.factor_or_rate.abs * 10000, precision: 0)
  end
end
  %>

<% content_for :title, "IPS Statement #{@statement.month_ending.strftime("%B %d %Y")}" %>

<%= turbo_stream_from dom_id(@statement, :show) %>
<%= turbo_stream_from dom_id(@statement, :errors) %>

<div class="d-flex justify-content-between gap-5">
  <div>
    <h1>IPS Statement</h1>

    <h4 class="text-secondary mt-3">Pragmatic Programmers LLC</h4>
    <h5 class="text-secondary">Client Statement</h5>
    <h5 class="mb-4"><span><span class="text-secondary">Month ending: </span><%= @statement.month_ending.strftime("%B %d %Y") %></h5>

    <%= render partial: "maybe_show_import_button", locals: { statement: @statement } %>
 </div>

  <div class="bg-secondary bg-gradient text-center align-self-center p-5">
    <%= bootstrap_form_with(model: @upload_files, url: upload_revenue_lines_royalties_ips_statement_path(@statement)) do |form| %>
      <div class="my-auto h-100">
        <h4>Upload Details Sheets</h4>


        <div class="text-primary">Drop IPS spreadsheets here</div>
        <div class="text-primary" style="--bs-text-opacity: .5;">(one or more at a time)</div>

        <div>
          <%= form.file_field :files, label: "&nbsp;".html_safe, multiple: true, accept: ".xlsx" %>
        </div>

        <div>
          <%= form.submit("Upload file(s)", class: "mt-3 btn btn-primary") %>
        </div>
      <% end %>
      </div>
  </div>
</div>
<%= render partial: "shared/oho_errors_list", locals: { object: @statement, errors: OhoError.for_object(@statement) } %>

<h3 class="mt-5 bg-dark-subtle text-center p-2">Revenues</h3>
<table class="table table-striped table-sm table-hover align-middle w-auto">
  <% @statement.revenues.group_by(&:section).each do |section, sections| %>
    <thead>
      <tr class="bg-secondary">
        <th colspan="4"></th>
        <th scope="col" class="text-end">Basis for charge</th>
        <th scope="col" class="text-end ps-4">Factor</th>
        <th scope="col" class="text-end ps-4">Due this month</th>
        <th scope="col" class="text-center ps-4">Uploaded</th>
      </tr>
    </thead>
    <tbody>
      <% sections.group_by(&:subsection).each do |subsection, details| %>
        <tr class="bg-light">
          <td colspan="8"><strong><%= subsection.upcase %></strong></td>
        </tr>
        <% details.each do |item| %>
          <tr>
            <td></td>
            <td><%= item.detail %></td>
            <td><%= item.month_due ? item.month_due.strftime("%B %Y") : "" %></td>
            <td class="text-end"><%= item.basis %></td>
            <td class="text-end"><%= number_to_currency(item.basis_for_charge) %></td>
            <td class="text-end"><%= number_to_percentage(item.factor_or_rate*10000, precision: 0) %></td>
            <td class="text-end"><%= number_to_currency(item.due_this_month) %></td>
            <td class="text-start ps-4" style="max-height: 1rem; text-overflow: hidden">
              <%= render partial: "detail_status", locals: { statement: @statement, item: item } %>
            </td>
          </tr>
        <% end %>
      <% end %>
    <% end %>

    </tbody>
</table>


<h3 class="mt-5 text-center bg-dark-subtle p-2">Expenses</h3>
<table class="table table-striped table-sm table-hover align-middle w-auto">
  <% @statement.expenses.group_by(&:section).each do |section, sections| %>
    <thead>
      <tr class="bg-secondary">
        <th colspan="3"></th>
        <th scope="col">Month Due</th>
        <th scope="col" class="text-center px-3">Basis</th>
        <th scope="col" class="text-end ps-3">Basis for charge</th>
        <th scope="col" class="text-end ps-3">Factor/rate</th>
        <th scope="col" class="text-end ps-3">Due this month</th>
      </tr>
    </thead>
    <tbody>
      <% sections.group_by(&:subsection).each do |subsection, details| %>
        <tr class="bg-light">
          <td colspan="3" class="text-uppercase mt-2"><strong><%= subsection %></strong></td>
        </tr>
        <% details.each do |item| %>
          <tr>
            <td></td>
            <td></td>
            <td><%= item.detail %></td>
            <td><%= item.month_due ? item.month_due.strftime("%B %Y") : "" %></td>
            <td class="text-center px-3"><%= item.basis %></td>
            <td class="text-end"><%= charge_basis(item) %></td>
            <td class="text-end"><%= charge_factor(item) %></td>
            <td class="text-end"><%= number_to_currency(item.due_this_month) %></td>
            <td class="text-start ps-4" style="max-height: 1rem; text-overflow: hidden">
              <%= render partial: "detail_status", locals: { statement: @statement, item: item } %>
            </td>
          </tr
        <% end %>
      <% end %>
    <% end %>

    </tbody>
</table>

