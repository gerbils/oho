<%
    ok_mime_types = [
      "application/vnd.ms-excel.sheet.macroEnabled",
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    ].join(",")
  %>
<% content_for :title, "Complete Upload" %>
<%
    def charge_basis(item)
      if item.basis == "unit"
        "x#{item.basis_for_charge.abs.to_i}"
      else
        number_to_currency(item.basis_for_charge)
      end
    end

def charge_factor(item)
  if item.basis == "unit"
    number_to_currency(item.factor_or_rate)
  elsif item.factor_or_rate == 100
    "100%"
    elseif item.factor_or_rate == -100
    "100%"
  else
    number_to_percentage(item.factor_or_rate.abs * 10000, precision: 0)
  end
end
  %>

<h1>IPS Details</h1>

<h4 class="text-secondary mt-3">Pragmatic Programmers LLC</h4>
<h5 class="text-secondary">Client Statement</h5>
<h5><span><span class="text-secondary">Month ending </span><%= @statement.month_ending.strftime("%B %d %Y") %></h5>

<h3 class="mt-5 bg-secondary">Revenues</h3>
<div class="d-flex gap-4 align-items-stretch">
  <table class="table table-striped table-sm table-hover align-middle">
    <thead>
      <tr>
        <th scope="col"></th>
        <th scope="col"></th>
        <th scope="col"></th>
        <th scope="col"></th>
        <th scope="col"></th>
        <th scope="col" class="text-end">Basis for charge</th>
        <th scope="col" class="text-end">Factor</th>
        <th scope="col" class="text-end">Due this month</th>
      </tr>
    </thead>
    <tbody>
      <% @statement.revenues.group_by(&:section).each do |section, sections| %>
        <tr class="bg-secondary">
          <td colspan="8"><strong><%= section %></strong></td>
        </tr>
        <% sections.group_by(&:subsection).each do |subsection, details| %>
          <tr class="bg-light">
            <td class="text-uppercase py-4"></td>
            <td colspan="7"><strong><%= subsection %></strong></td>
          </tr>
          <% details.each do |item| %>
            <tr>
              <td></td>
              <td></td>
              <td><%= item.detail %></td>
              <td><%= item.month_due ? item.month_due.strftime("%B %Y") : "" %></td>
              <td class="text-end"><%= item.basis %></td>
              <td class="text-end"><%= number_to_currency(item.basis_for_charge) %></td>
              <td class="text-end"><%= number_to_percentage(item.factor_or_rate*10000, precision: 0) %></td>
              <td class="text-end"><%= number_to_currency(item.due_this_month) %></td>
            </tr>
          <% end %>
        <% end %>
      <% end %>

    </tbody>
  </table>

  <div class="bg-secondary bg-gradient text-center align-self-center p-5">
    <%= bootstrap_form_with(model: @upload_wrapper, url: upload_revenue_lines_royalties_ips_ips_statement_path(@statement)) do |form| %>
      <div class="my-auto h-100">
        <h4>Upload Revenue Files</h4>
        <p>Drop all revenue files here (one or more at a time)</p>

        <div>
          <%= form.file_field :file, multiple: false, accept: ".xlsx" %>
        </div>

        <div>
          <%= form.submit("Upload file(s)", class: "mt-3 btn btn-primary") %>
        </div>
      <% end %>
      </div>
  </div>
</div>

<h3 class="mt-5 bg-secondary">Expenses</h3>
<table class="table table-striped table-sm table-hover align-middle">
  <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col"></th>
      <th scope="col"></th>
      <th scope="col">Month Due</th>
      <th scope="col">Basis</th>
      <th scope="col" class="text-end">Basis for charge</th>
      <th scope="col" class="text-end">Factor/rate</th>
      <th scope="col" class="text-end">Due this month</th>
    </tr>
  </thead>
  <tbody>
    <% @statement.expenses.group_by(&:section).each do |section, sections| %>
      <tr class="bg-secondary">
        <td colspan="8"><strong><%= section %></strong></td>
      </tr>
      <% sections.group_by(&:subsection).each do |subsection, details| %>
        <tr class="bg-light">
          <td class="py-4"></td>
          <td colspan="7" class="text-uppercase mt-2"><strong><%= subsection %></strong></td>
        </tr>
        <% details.each do |item| %>
          <tr>
            <td></td>
            <td></td>
            <td><%= item.detail %></td>
            <td><%= item.month_due ? item.month_due.strftime("%B %Y") : "" %></td>
            <td><%= item.basis %></td>
            <td class="text-end"><%= charge_basis(item) %></td>
            <td class="text-end"><%= charge_factor(item) %></td>
            <td class="text-end"><%= number_to_currency(item.due_this_month) %></td>
          </tr>
        <% end %>
      <% end %>
    <% end %>

  </tbody>
</table>

